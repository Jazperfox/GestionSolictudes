<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Autorizar Solicitudes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        #previewFrame {
            width: 100%;
            height: 500px;
            border: none;
        }
        #previewImage {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>

<body class="p-4 bg-light">

<div class="container">
    <h2 class="mb-4 text-primary">Solicitudes a Autorizar/Denegar</h2>

    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-bordered table-striped align-middle">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Categoría</th>
                    <th>Creador</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Prioridad</th>
                    <th>Adjunto</th>
                    <th>Acciones</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="solicitud : ${autorizar}">
                    <td th:text="${solicitud.idSolicitud}" class="fw-bold"></td>

                    <td>
                        <span th:each="cat : ${categorias}" th:if="${cat.idCategoria == solicitud.idCategoriaSolicitud}" th:text="${cat.nombre}"></span>
                    </td>
                    <td>
                        <span th:each="u : ${usuarios}" th:if="${u.idUsuario == solicitud.idUsuarioCreacion}" th:text="${u.nombreUsuario}"></span>
                    </td>

                    <td th:text="${solicitud.fechaCreacion}"></td>

                    <td>
                        <span class="badge" th:each="est : ${estados}" th:if="${est.idEstado == solicitud.idEstadoSolicitud}" th:text="${est.estado}"
                              th:classappend="${est.estado == 'CREADA' ? ' bg-success' : est.estado == 'EN PROCESO' ? ' bg-warning text-dark' : est.estado == 'DENEGADA' ? ' bg-danger' : ' bg-secondary'}">
                        </span>
                    </td>

                    <td>
                        <span th:each="pri : ${prioridades}" th:if="${pri.idPrioridad == solicitud.idPrioridad}" th:text="${pri.nombrePrioridad}"
                              th:classappend="${pri.nombrePrioridad == 'Alta' ? 'text-danger fw-bold' : ''}">
                        </span>
                    </td>

                    <td class="text-center">
                        <div th:if="${solicitud.rutaAdjunto != null and !solicitud.rutaAdjunto.isEmpty()}"
                             th:with="ruta=${solicitud.rutaAdjunto.toLowerCase()},
                                      esImagen=${#strings.endsWith(ruta, '.jpg') or #strings.endsWith(ruta, '.jpeg') or #strings.endsWith(ruta, '.png')},
                                      esPdf=${#strings.endsWith(ruta, '.pdf')}">

                            <button th:if="${esImagen or esPdf}"
                                    type="button"
                                    class="btn btn-sm btn-outline-info"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalVisualizar"
                                    title="Visualizar Archivo"
                                    th:onclick="cargarPrevisualizacion([[${solicitud.idSolicitud}]], [[${esImagen}]])">
                                <i class="bi bi-eye-fill"></i> Ver
                            </button>

                            <a th:unless="${esImagen or esPdf}"
                               th:href="@{/solicitud/descargar/{id}(id=${solicitud.idSolicitud})}"
                               class="btn btn-sm btn-outline-primary"
                               title="Descargar Archivo">
                                <i class="bi bi-download"></i> Bajar
                            </a>
                        </div>
                        <span th:unless="${solicitud.rutaAdjunto != null and !solicitud.rutaAdjunto.isEmpty()}" class="text-muted">-</span>
                    </td>

                    <td>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalActualizar"
                                th:attr="data-id=${solicitud.idSolicitud}, data-estado=${solicitud.idEstadoSolicitud}">
                            <i class="bi bi-pencil-square"></i> Actualizar
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVisualizar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Vista Previa del Archivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body text-center bg-dark">
                <img id="previewImage" src="" alt="Vista previa" style="display: none;">
                <iframe id="previewFrame" src="" style="display: none;"></iframe>
                <div id="loadingMsg" class="text-white">Cargando...</div>
            </div>

            <div class="modal-footer bg-light">
                <a id="btnDescargarModal" href="#" class="btn btn-primary">
                    <i class="bi bi-download"></i> Descargar
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalActualizar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/solicitud/actualizarAutorizacion}" method="post">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Actualizar Solicitud</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">ID Solicitud</label>
                        <input type="text" id="modalIdSolicitud" name="idSolicitud" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Estado Actual</label>
                        <input type="text" id="modalNombreEstado" class="form-control mb-2" readonly>
                        <label class="form-label fw-bold">Nuevo Estado</label>
                        <select name="idEstado" class="form-select" required>
                            <option value="">-- Seleccionar Estado --</option>
                            <option th:each="est : ${estados}" th:value="${est.idEstado}" th:text="${est.estado}" th:if="${est.estado!='CREADO' and est.estado!='EN PROCESO' and est.estado !='CREADA'}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Comentario</label>
                        <textarea name="comentario" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">

    // --- LÓGICA PARA EL MODAL DE ACTUALIZAR ---
    const modalAct = document.getElementById('modalActualizar');
    modalAct.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;
        const idSolicitud = button.getAttribute('data-id');
        const idEstado = button.getAttribute('data-estado');
        document.getElementById('modalIdSolicitud').value = idSolicitud;
        const estados = /*[[${estados}]]*/ [];
        const estadoActual = estados.find(e => e.idEstado == idEstado);
        document.getElementById('modalNombreEstado').value = estadoActual ? estadoActual.estado : "Desconocido";
    });

    // --- LÓGICA PARA EL MODAL DE VISUALIZAR Y DESCARGAR ---
    function cargarPrevisualizacion(idSolicitud, esImagen) {
        const urlVer = '/solicitud/ver-archivo/' + idSolicitud;
        const urlDescargar = '/solicitud/descargar/' + idSolicitud; // URL de descarga

        const img = document.getElementById('previewImage');
        const iframe = document.getElementById('previewFrame');
        const loading = document.getElementById('loadingMsg');

        // **Actualizamos el botón de descarga del modal**
        const btnDescargar = document.getElementById('btnDescargarModal');
        btnDescargar.href = urlDescargar;

        // Resetear visualización
        img.style.display = 'none';
        iframe.style.display = 'none';
        loading.style.display = 'block';

        if (esImagen) {
            img.src = urlVer;
            img.onload = function() { loading.style.display = 'none'; img.style.display = 'block'; };
        } else {
            iframe.src = urlVer;
            loading.style.display = 'none';
            iframe.style.display = 'block';
        }
    }

    // Limpiar el modal al cerrar
    const modalVis = document.getElementById('modalVisualizar');
    modalVis.addEventListener('hidden.bs.modal', function () {
        document.getElementById('previewImage').src = "";
        document.getElementById('previewFrame').src = "";
    });

</script>

</body>
</html>